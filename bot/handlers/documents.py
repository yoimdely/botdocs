from __future__ import annotations

import re
from dataclasses import dataclass
from pathlib import Path
from typing import Dict, List

from aiogram import F, Router
from aiogram import Bot
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import BufferedInputFile, CallbackQuery, InlineKeyboardButton, InlineKeyboardMarkup, Message

from ..config import Settings
from ..services.analytics import AnalyticsService
from ..services.docx_builder import DocxBuilder
from ..services.limits import can_create_document, register_document_usage
from ..services.pdf_builder import PdfBuilder
from ..services.subscription import is_subscribed
from ..services.storage import GeneratedDocument, StorageService
from ..services.templates_loader import TemplateLoader
from .keyboards import subscription_keyboard
from .middleware import DependencyMiddleware

PASSPORT_PATTERN = r"^\d{4}\s?\d{6}$"
DATE_PATTERN = r"^\d{2}\.\d{2}\.\d{4}$"
DATE_RANGE_PATTERN = r"^\d{2}\.\d{2}\.\d{4}\s?-\s?\d{2}\.\d{2}\.\d{4}$"
AMOUNT_PATTERN = r"^\d{1,3}(?:\s?\d{3})*(?:[\.,]\d{2})?$"
VIN_PATTERN = r"^[A-HJ-NPR-Z0-9]{17}$"


@dataclass
class DocumentQuestion:
    key: str
    prompt: str
    example: str | None = None
    pattern: str | None = None
    error_hint: str | None = None
    uppercase: bool = False


@dataclass
class DocumentDefinition:
    code: str
    title: str
    template: str
    category: str
    questions: List[DocumentQuestion]


def q(
    key: str,
    prompt: str,
    example: str | None = None,
    pattern: str | None = None,
    error_hint: str | None = None,
    uppercase: bool = False,
) -> DocumentQuestion:
    return DocumentQuestion(
        key=key,
        prompt=prompt,
        example=example,
        pattern=pattern,
        error_hint=error_hint,
        uppercase=uppercase,
    )


CATEGORY_META: Dict[str, str] = {
    "sale": "🛒 Купля-продажа",
    "rent": "🏠 Аренда и недвижимость",
    "services": "🛠 Услуги и работы",
    "papers": "📄 Расписки и полномочия",
    "claims": "⚖ Претензии и расчёты",
}


TEMPLATES_DIR = Path(__file__).resolve().parent.parent / "data" / "templates"


DOCUMENTS_DATA = [
    {
        "code": "dkp_goods",
        "title": "Договор купли-продажи имущества",
        "template": "dkp_template.jinja",
        "category": "sale",
        "questions": [
            q("seller_full_name", "Введите ФИО продавца полностью (как в паспорте):", "Иванов Иван Иванович"),
            q(
                "seller_passport",
                "Укажите серию и номер паспорта продавца (формат 0000 000000):",
                "4500 123456",
                PASSPORT_PATTERN,
                "Используйте четыре цифры серии и шесть цифр номера",
            ),
            q("seller_address", "Введите адрес регистрации продавца (город, улица, дом, квартира):", "г. Москва, ул. Ленина, д. 10, кв. 15"),
            q("buyer_full_name", "Введите ФИО покупателя полностью:", "Петров Пётр Петрович"),
            q(
                "buyer_passport",
                "Укажите серию и номер паспорта покупателя:",
                "4500 654321",
                PASSPORT_PATTERN,
                "Пример: 4500 654321",
            ),
            q("buyer_address", "Введите адрес регистрации покупателя:", "г. Санкт-Петербург, наб. Реки Карповки, д. 5"),
            q("item_description", "Опишите продаваемое имущество (марка, модель, уникальные признаки):", "Ноутбук Apple MacBook Pro 14, серийный № ХХХ"),
            q(
                "item_condition",
                "Уточните состояние, комплектацию и известные недостатки предмета:",
                "Б/у, следы эксплуатации, комплект: устройство, блок питания, чек",
            ),
            q(
                "price_amount",
                "Укажите цену договора в рублях (только цифры и пробелы):",
                "120 000",
                AMOUNT_PATTERN,
                "Не используйте текст или символы, кроме цифр и пробелов",
            ),
            q("payment_terms", "Опишите порядок расчётов (когда и как будет оплачен товар):", "Оплата наличными в день подписания договора"),
            q(
                "transfer_conditions",
                "Опишите порядок передачи имущества и подписание акта:",
                "Передача по акту не позднее 3 дней с даты оплаты",
            ),
            q(
                "risk_transfer_terms",
                "Укажите момент перехода рисков и ответственности:",
                "Риски переходят к Покупателю после подписания акта приёма-передачи",
            ),
            q("signing_place", "Введите город заключения договора (без сокращения «г.»):", "Москва"),
            q(
                "signing_date",
                "Введите дату подписания договора в формате ДД.ММ.ГГГГ:",
                "15.03.2025",
                DATE_PATTERN,
                "Используйте точный формат, например 05.09.2025",
            ),
        ],
    },
    {
        "code": "dkp_car",
        "title": "Договор купли-продажи транспортного средства",
        "template": "dkp_car_template.jinja",
        "category": "sale",
        "questions": [
            q("seller_full_name", "Введите ФИО продавца автомобиля полностью:", "Сидоров Сергей Алексеевич"),
            q("seller_passport", "Серия и номер паспорта продавца (0000 000000):", "4500 789456", PASSPORT_PATTERN, "Только цифры и пробел"),
            q("seller_address", "Адрес регистрации продавца:", "г. Санкт-Петербург, пр-т Лиговский, д. 12"),
            q("buyer_full_name", "Введите ФИО покупателя полностью:", "Романов Андрей Петрович"),
            q("buyer_passport", "Серия и номер паспорта покупателя:", "4500 112233", PASSPORT_PATTERN, "Используйте формат 0000 000000"),
            q("buyer_address", "Адрес регистрации покупателя:", "г. Москва, пр-т Мира, д. 45"),
            q("vehicle_description", "Опишите автомобиль (марка, модель, цвет, госномер):", "Nissan Qashqai, серый, госномер А123ВС77"),
            q("vin", "Введите VIN автомобиля (17 символов без пробелов):", "JN1TANT31U0123456", VIN_PATTERN, "Разрешены латинские буквы и цифры", True),
            q("production_year", "Введите год выпуска автомобиля (четыре цифры):", "2020", r"^(19|20)\d{2}$", "Пример: 2021"),
            q(
                "mileage",
                "Укажите пробег автомобиля на дату сделки (км, только цифры):",
                "84500",
                r"^\d{1,7}$",
                "Используйте только цифры, без пробелов и знаков",
            ),
            q(
                "equipment_list",
                "Опишите комплектность (ключи, документы, доп. оборудование):",
                "2 ключа, ПТС, СТС, сервисная книга, комплект зимней резины",
            ),
            q(
                "vehicle_condition",
                "Укажите техническое состояние и зафиксированные повреждения:",
                "Состояние исправное, сколы ЛКП на бампере, ТО пройдено",
            ),
            q(
                "known_defects",
                "Перечислите известные недостатки или ограничения (при наличии):",
                "Не работает подогрев сиденья водителя",
            ),
            q("price_amount", "Укажите стоимость автомобиля в рублях:", "1 150 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("payment_terms", "Опишите порядок оплаты (сроки, способ перевода):", "Безналичный перевод в течение 3 дней после подписания"),
            q(
                "risk_transfer_moment",
                "Определите момент перехода права собственности и рисков:",
                "С момента подписания акта приёма-передачи и передачи ключей",
            ),
            q(
                "registration_term",
                "Срок и порядок регистрации ТС на Покупателя:",
                "Покупатель регистрирует ТС в ГИБДД в течение 10 календарных дней",
            ),
            q(
                "fine_liability_terms",
                "Распределение ответственности за штрафы и платежи до/после передачи:",
                "Штрафы до даты передачи оплачивает Продавец, после передачи — Покупатель",
            ),
            q("signing_place", "Город заключения договора:", "Санкт-Петербург"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "20.04.2025", DATE_PATTERN, "Формат 25.12.2025"),
        ],
    },
    {
        "code": "dkp_property",
        "title": "Договор купли-продажи недвижимости",
        "template": "dkp_property_template.jinja",
        "category": "sale",
        "questions": [
            q("seller_full_name", "ФИО продавца полностью:", "Морозова Анна Викторовна"),
            q("seller_passport", "Серия и номер паспорта продавца:", "4500 334455", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("seller_address", "Адрес регистрации продавца:", "г. Казань, ул. Заречная, д. 3"),
            q("buyer_full_name", "ФИО покупателя полностью:", "Смирнов Олег Сергеевич"),
            q("buyer_passport", "Серия и номер паспорта покупателя:", "4500 445566", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("buyer_address", "Адрес регистрации покупателя:", "г. Казань, ул. Чистопольская, д. 8"),
            q("property_address", "Полный адрес объекта недвижимости:", "г. Казань, ул. Центральная, д. 7, кв. 12"),
            q(
                "cadastral_number",
                "Кадастровый номер (формат 00:00:0000000:0000):",
                "77:01:0004010:1234",
                r"^\d{2}:\d{2}:\d{7}:\d{1,4}$",
                "Используйте двоеточия и только цифры",
            ),
            q(
                "property_area",
                "Общая площадь объекта в кв. м (разрешены десятичные через точку или запятую):",
                "54.3",
                r"^\d{1,4}(?:[\.,]\d{1,2})?$",
                "Пример: 67.5",
            ),
            q("property_floor", "Этаж и количество этажей (например, 5/12):", "5/17"),
            q(
                "property_purpose",
                "Назначение и состав помещений (жилое/нежилое, комнаты, санузлы):",
                "Жилое помещение: 2 комнаты, кухня, санузел совмещённый",
            ),
            q(
                "property_condition",
                "Текущее состояние (ремонт, износ, особенности):",
                "Косметический ремонт 2022 года, следы эксплуатации",
            ),
            q(
                "included_items",
                "Перечень передаваемого имущества и оснащения:",
                "Встроенная кухня, плита, холодильник, шкаф-купе",
            ),
            q("price_amount", "Укажите цену объекта в рублях:", "8 500 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("settlement_terms", "Опишите порядок расчётов (аккредитив, сроки, банк):", "Аккредитив до 01.05.2025 в банке Х"),
            q("transfer_terms", "Опишите порядок передачи объекта (дата, акт, ключи):", "Передача по акту в течение 5 дней после регистрации"),
            q(
                "key_transfer_terms",
                "Уточните порядок передачи ключей и средств доступа:",
                "Ключи и коды домофона передаются в день подписания акта",
            ),
            q(
                "utility_settlement",
                "Кто оплачивает коммунальные услуги до и после передачи:",
                "До даты акта оплачивает Продавец, далее — Покупатель",
            ),
            q("signing_place", "Город заключения договора:", "Казань"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "30.04.2025", DATE_PATTERN, "Например, 30.04.2025"),
        ],
    },
    {
        "code": "rent_flat",
        "title": "Договор аренды квартиры",
        "template": "rent_template.jinja",
        "category": "rent",
        "questions": [
            q("landlord_full_name", "ФИО арендодателя полностью:", "Кузнецова Елена Игоревна"),
            q("landlord_passport", "Паспорт арендодателя (0000 000000):", "4500 778899", PASSPORT_PATTERN, "Только цифры и пробел"),
            q("landlord_address", "Адрес регистрации арендодателя:", "г. Москва, ул. Пречистенка, д. 9"),
            q("tenant_full_name", "ФИО арендатора полностью:", "Орлов Максим Андреевич"),
            q("tenant_passport", "Паспорт арендатора:", "4500 998877", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("tenant_address", "Адрес регистрации арендатора:", "г. Москва, ул. Русаковская, д. 18"),
            q("property_address", "Адрес сдаваемой квартиры:", "г. Москва, ул. Пушкина, д. 10, кв. 5"),
            q(
                "property_area",
                "Площадь и характеристики квартиры (кв. м, комнаты, этаж):",
                "54 кв.м, 2 комнаты, 6 этаж",
            ),
            q(
                "rent_term",
                "Срок аренды (укажите диапазон ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.06.2025-31.05.2026",
                DATE_RANGE_PATTERN,
                "Пример: 01.06.2025-31.05.2026",
            ),
            q("rent_amount", "Размер ежемесячной арендной платы в рублях:", "65 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("deposit_amount", "Сумма обеспечительного платежа (залог) в рублях:", "65 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q(
                "payment_schedule",
                "Срок внесения арендной платы каждый месяц:",
                "До 5-го числа оплачиваемого месяца",
            ),
            q(
                "furnishing_details",
                "Опишите мебель, технику и состояние при передаче:",
                "Квартира меблирована, техника: холодильник, стиральная машина",
            ),
            q(
                "handover_condition",
                "Состояние квартиры и уборка при передаче:",
                "Чистое жилое состояние, без повреждений стен и пола",
            ),
            q("utilities_terms", "Опишите, кто оплачивает коммунальные услуги и как:", "Коммунальные услуги оплачивает арендатор по квитанциям"),
            q(
                "maintenance_rules",
                "Правила эксплуатации и мелкий ремонт (шум, животные, техника):",
                "Соблюдать правила дома, мелкий ремонт за счёт арендатора",
            ),
            q(
                "key_transfer_terms",
                "Сколько ключей и когда передаются:",
                "2 комплекта ключей в день подписания акта",
            ),
            q("signing_place", "Город заключения договора:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "20.05.2025", DATE_PATTERN, "Например, 20.05.2025"),
        ],
    },
    {
        "code": "rent_room",
        "title": "Договор аренды комнаты",
        "template": "rent_room_template.jinja",
        "category": "rent",
        "questions": [
            q("landlord_full_name", "ФИО арендодателя полностью:", "Новикова Дарья Павловна"),
            q("landlord_passport", "Паспорт арендодателя:", "4500 223344", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("landlord_address", "Адрес регистрации арендодателя:", "г. Тула, ул. Гагарина, д. 2"),
            q("tenant_full_name", "ФИО арендатора полностью:", "Егоров Иван Евгеньевич"),
            q("tenant_passport", "Паспорт арендатора:", "4500 556677", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("tenant_address", "Адрес регистрации арендатора:", "г. Тула, ул. Болдина, д. 14"),
            q("room_description", "Опишите комнату (адрес, номер комнаты, площадь):", "г. Тула, ул. Мира, д. 8, комната 2, 14 кв.м"),
            q(
                "room_condition",
                "Состояние комнаты (мебель, ремонт, окна):",
                "Комната меблирована, свежий косметический ремонт",
            ),
            q(
                "rent_term",
                "Срок аренды (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.05.2025-30.09.2025",
                DATE_RANGE_PATTERN,
                "Например, 01.05.2025-30.09.2025",
            ),
            q("rent_amount", "Размер ежемесячной платы в рублях:", "18 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("payment_schedule", "Дата внесения платы каждый месяц:", "До 3 числа оплачиваемого месяца"),
            q("utilities_terms", "Кто и как оплачивает коммунальные услуги:", "Свет и вода делятся поровну"),
            q("shared_areas", "Правила пользования общей кухней, санузлом и т.п.:", "Кухня и санузел по графику, уборка раз в неделю"),
            q(
                "furnishing_details",
                "Опишите комплект мебели и бытовой техники:",
                "Кровать, шкаф, стол, стул, мини-холодильник",
            ),
            q(
                "house_rules",
                "Дополнительные правила проживания (гости, тишина, животные):",
                "Гости до 22:00, без домашних животных",
            ),
            q(
                "key_transfer_terms",
                "Количество ключей и момент передачи:",
                "1 комплект ключей в день подписания акта",
            ),
            q("signing_place", "Город заключения договора:", "Тула"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "10.04.2025", DATE_PATTERN, "Формат 10.04.2025"),
        ],
    },
    {
        "code": "rent_car",
        "title": "Договор аренды автомобиля",
        "template": "rent_car_template.jinja",
        "category": "rent",
        "questions": [
            q("owner_full_name", "ФИО собственника автомобиля полностью:", "Зайцев Дмитрий Львович"),
            q("owner_passport", "Паспорт собственника:", "4500 887766", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("owner_address", "Адрес регистрации собственника:", "г. Нижний Новгород, ул. Белинского, д. 30"),
            q("renter_full_name", "ФИО арендатора:", "Волкова Наталья Олеговна"),
            q("renter_passport", "Паспорт арендатора:", "4500 334466", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("renter_address", "Адрес регистрации арендатора:", "г. Нижний Новгород, ул. Рождественская, д. 11"),
            q("vehicle_description", "Опишите автомобиль (марка, модель, госномер, цвет):", "Toyota Camry, белый, В789КХ99"),
            q("vin", "VIN автомобиля (17 символов):", "JTNB13HK503045612", VIN_PATTERN, "Проверяйте отсутствие O и I", True),
            q(
                "mileage",
                "Пробег автомобиля на дату передачи (км, цифры):",
                "73500",
                r"^\d{1,7}$",
                "Только цифры без пробелов",
            ),
            q(
                "vehicle_condition",
                "Техническое состояние и зафиксированные повреждения:",
                "Исправное, мелкие сколы ЛКП на переднем бампере",
            ),
            q(
                "equipment_list",
                "Комплектность при передаче (ключи, документы, доп. оборудование):",
                "2 ключа, ПТС, СТС, диагностическая карта, комплект зимних шин",
            ),
            q(
                "rent_term",
                "Срок аренды (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.06.2025-31.08.2025",
                DATE_RANGE_PATTERN,
                "Например, 01.06.2025-31.08.2025",
            ),
            q("rent_fee", "Арендная плата (укажите период, например «в месяц») в рублях:", "45 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("deposit_amount", "Сумма залога в рублях:", "30 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q(
                "fuel_level",
                "Уровень топлива при передаче (например, «полный бак»):",
                "Полный бак",
            ),
            q(
                "usage_limitations",
                "Ограничения на использование (пробег, территория, водители):",
                "Не более 3000 км в месяц, управление только арендаторм",
            ),
            q(
                "insurance_terms",
                "Информация о страховании и порядке урегулирования ДТП:",
                "ОСАГО действует до 12.12.2025, при ДТП немедленно уведомлять собственника",
            ),
            q(
                "maintenance_rules",
                "Обязанности по обслуживанию и штрафам:",
                "Текущий уход и штрафы за нарушение ПДД несёт арендатор",
            ),
            q("signing_place", "Город заключения договора:", "Нижний Новгород"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "18.05.2025", DATE_PATTERN, "Пример: 18.05.2025"),
        ],
    },
    {
        "code": "realtor",
        "title": "Договор с риелтором",
        "template": "realtor_template.jinja",
        "category": "rent",
        "questions": [
            q("client_name", "ФИО или название клиента:", "ООО «Авангард»"),
            q("realtor_name", "ФИО или название риелтора/агентства:", "ИП Сидоров П.П."),
            q("request_description", "Опишите задачу, которую должен решить риелтор:", "Подбор квартиры для долгосрочной аренды"),
            q(
                "object_parameters",
                "Ключевые параметры искомого объекта (район, бюджет, метраж):",
                "Москва, до 80 000 руб./мес, от 45 кв.м, не выше 10 этажа",
            ),
            q(
                "fee_amount",
                "Укажите размер вознаграждения в рублях:",
                "120 000",
                AMOUNT_PATTERN,
                "Только цифры и пробелы",
            ),
            q(
                "agreement_term",
                "Срок действия поручения (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.05.2025-01.08.2025",
                DATE_RANGE_PATTERN,
                "Например, 01.05.2025-01.08.2025",
            ),
            q("payment_terms", "Опишите порядок оплаты вознаграждения:", "50% авансом, 50% после подписания договора"),
            q(
                "reporting_terms",
                "Периодичность и формат отчётности риелтора:",
                "Еженедельные отчёты в Telegram с перечнем предложений",
            ),
            q(
                "exclusive_terms",
                "Есть ли исключительность поручения и запрет на привлечение других агентов:",
                "Поручение эксклюзивное на срок договора",
            ),
            q(
                "result_criteria",
                "Каким считается результат (сделка, подбор вариантов, аванс):",
                "Результат — подписание договора аренды подходящего объекта",
            ),
            q("signing_place", "Город заключения договора:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "25.04.2025", DATE_PATTERN, "Формат 25.04.2025"),
        ],
    },
    {
        "code": "service_contract",
        "title": "Договор оказания услуг",
        "template": "service_contract_template.jinja",
        "category": "services",
        "questions": [
            q("customer_name", "Название или ФИО заказчика:", "ООО «Бета»"),
            q("customer_details", "Реквизиты заказчика (ИНН, адрес, ОГРН при наличии):", "ИНН 7700000000, 123456, г. Москва, ул. Центральная, д. 5"),
            q("contractor_name", "Название или ФИО исполнителя:", "ИП Плотников А.А."),
            q("contractor_details", "Реквизиты исполнителя:", "ИНН 5000000000, г. Подольск, ул. Заводская, д. 2"),
            q("service_description", "Опишите услуги, которые нужно оказать:", "Юридическое сопровождение договора поставки"),
            q(
                "service_scope_details",
                "Расшифруйте состав и объём услуг (отчёты, консультации, визиты):",
                "Проверка договора, 3 консультации, подготовка заключения",
            ),
            q(
                "service_term",
                "Укажите период оказания услуг (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.05.2025-31.05.2025",
                DATE_RANGE_PATTERN,
                "Пример: 01.05.2025-31.05.2025",
            ),
            q("service_price", "Стоимость услуг в рублях:", "250 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("payment_terms", "Опишите порядок оплаты (аванс, рассрочка, сроки):", "100% в течение 5 дней после подписания"),
            q(
                "acceptance_procedure",
                "Как принимается результат (акт, срок проверки, кто подписывает):",
                "Акт сдачи-приёмки в течение 3 дней после предоставления отчёта",
            ),
            q(
                "quality_requirements",
                "Требования к качеству и стандартам услуг:",
                "Исполнитель соблюдает требования законодательства и конфиденциальность",
            ),
            q(
                "liability_terms",
                "Ответственность за просрочку и качество:",
                "Неустойка 0,1% в день просрочки, возмещение документально подтверждённых убытков",
            ),
            q("signing_place", "Город заключения договора:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "30.04.2025", DATE_PATTERN, "Формат 30.04.2025"),
        ],
    },
    {
        "code": "contractor",
        "title": "Договор подряда",
        "template": "contractor_template.jinja",
        "category": "services",
        "questions": [
            q("customer_name", "Название или ФИО заказчика:", "ООО «ДомСтрой»"),
            q("customer_details", "Реквизиты заказчика:", "ИНН 7700001111, г. Москва, ул. Советская, д. 8"),
            q("contractor_name", "Название или ФИО подрядчика:", "ИП Малкин М.М."),
            q("contractor_details", "Реквизиты подрядчика:", "ИНН 5000001111, г. Видное, ул. Садовая, д. 4"),
            q("work_description", "Опишите виды работ, которые нужно выполнить:", "Капитальный ремонт офиса (отделка + инженерные сети)"),
            q(
                "design_basis",
                "Основание для работ (проект, ТЗ, смета):",
                "Проект №15/2025 и смета от 10.04.2025",
            ),
            q(
                "completion_term",
                "Срок выполнения работ (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.05.2025-31.07.2025",
                DATE_RANGE_PATTERN,
                "Например, 01.05.2025-31.07.2025",
            ),
            q("work_price", "Стоимость работ в рублях:", "3 200 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("materials_terms", "Кто предоставляет материалы и входят ли они в цену:", "Материалы подрядчика включены в стоимость"),
            q(
                "acceptance_procedure",
                "Порядок приёмки работ (этапы, акты, сроки проверки):",
                "Промежуточные акты ежемесячно, итоговый акт в течение 5 дней после сдачи",
            ),
            q(
                "warranty_terms",
                "Гарантийные обязательства подрядчика:",
                "Гарантия 12 месяцев на выполненные работы",
            ),
            q(
                "penalty_terms",
                "Неустойка за просрочку и нарушение качества:",
                "0,1% от цены работ за каждый день просрочки",
            ),
            q("signing_place", "Город заключения договора:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "25.04.2025", DATE_PATTERN, "Пример: 25.04.2025"),
        ],
    },
    {
        "code": "household",
        "title": "Договор бытовых услуг",
        "template": "household_template.jinja",
        "category": "services",
        "questions": [
            q("customer_name", "ФИО заказчика полностью:", "Смирнова Анна Сергеевна"),
            q("customer_passport", "Паспорт заказчика (0000 000000):", "4500 667788", PASSPORT_PATTERN, "Пример: 4500 667788"),
            q("contractor_name", "ФИО исполнителя полностью:", "ИП Лебедев Д.Д."),
            q("contractor_passport", "Паспорт исполнителя:", "4500 889900", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("work_description", "Опишите бытовые работы/услуги:", "Пошив костюма по индивидуальным меркам"),
            q(
                "completion_term",
                "Срок выполнения (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.05.2025-20.05.2025",
                DATE_RANGE_PATTERN,
                "Пример: 01.05.2025-20.05.2025",
            ),
            q("work_price", "Стоимость услуг в рублях:", "35 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("materials_terms", "Опишите, кто предоставляет материалы:", "Материалы исполнителя включены в цену"),
            q(
                "quality_requirements",
                "Требования к качеству результата и примерки:",
                "Изделие должно соответствовать ТЗ, примерка не реже двух раз",
            ),
            q(
                "acceptance_procedure",
                "Порядок приёмки и исправления недостатков:",
                "Приёмка по акту, исправления в течение 5 дней после замечаний",
            ),
            q(
                "penalty_terms",
                "Ответственность за просрочку или брак:",
                "Неустойка 0,2% в день и бесплатное устранение брака",
            ),
            q("work_address", "Адрес, где выполняются работы:", "г. Москва, ул. Арбат, д. 12"),
            q("signing_place", "Город заключения договора:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "24.04.2025", DATE_PATTERN, "Формат 24.04.2025"),
        ],
    },
    {
        "code": "photography",
        "title": "Договор оказания услуг фотографа",
        "template": "photography_template.jinja",
        "category": "services",
        "questions": [
            q("client_name", "ФИО/название клиента:", "ООО «Свет»"),
            q("client_contacts", "Контакты клиента (телефон, e-mail):", "+7 900 000-00-00, photo@example.com"),
            q("photographer_name", "ФИО фотографа:", "ИП Соловьёв Н.Н."),
            q("shoot_date_place", "Дата и место съёмки:", "15.06.2025, парк Зарядье"),
            q(
                "shoot_hours",
                "Продолжительность съёмки в часах (1-12):",
                "5",
                r"^\d{1,2}$",
                "Введите целое число от 1 до 12",
            ),
            q(
                "shoot_plan",
                "План и формат съёмки (сцены, количество площадок):",
                "Съемка регистрации, прогулки и банкета на двух локациях",
            ),
            q("deliverables", "Что получает клиент (кол-во фото, формат, сроки):", "50 отретушированных фотографий + ссылка на архив"),
            q("price_amount", "Стоимость услуг в рублях:", "80 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("payment_terms", "Опишите порядок оплаты (аванс, расчёт в день съёмки):", "30% аванс, 70% в день съёмки"),
            q(
                "location_rules",
                "Требования к локации и допуска к площадкам:",
                "Клиент обеспечивает пропуска и доступ на частную территорию",
            ),
            q(
                "usage_rights",
                "Права использования фотографий (личные/коммерческие):",
                "Личные цели клиента, публикации фотографа возможны с согласия",
            ),
            q(
                "reschedule_terms",
                "Условия переноса или отмены съёмки:",
                "Перенос не позднее чем за 72 часа, иначе удержание аванса",
            ),
            q("signing_place", "Город заключения договора:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "01.05.2025", DATE_PATTERN, "Формат 01.05.2025"),
        ],
    },
    {
        "code": "work_completion",
        "title": "Акт выполненных работ",
        "template": "work_completion_template.jinja",
        "category": "services",
        "questions": [
            q("customer_name", "Название или ФИО заказчика:", "ООО «СтройПро»"),
            q("contractor_name", "Название или ФИО исполнителя:", "ИП Линин В.В."),
            q("work_scope", "Перечень и объём выполненных работ:", "Отделочные работы по договору №10"),
            q("contract_reference", "Основание (договор, заявка) и дата:", "Договор подряда №10 от 01.02.2025"),
            q(
                "completion_dates",
                "Период выполнения работ (ДД.ММ.ГГГГ-ДД.ММ.ГГГГ):",
                "01.03.2025-31.03.2025",
                DATE_RANGE_PATTERN,
                "Пример: 01.03.2025-31.03.2025",
            ),
            q("work_price", "Стоимость работ по акту в рублях:", "420 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q(
                "quality_notes",
                "Сведения о качестве и выявленных недостатках (если есть):",
                "Работы выполнены качественно, замечаний нет",
            ),
            q(
                "claims_terms",
                "Срок и порядок предъявления претензий после подписания:",
                "Претензии по скрытым недостаткам — в течение 20 дней",
            ),
            q("signing_place", "Город подписания акта:", "Москва"),
            q("signing_date", "Дата подписания акта (ДД.ММ.ГГГГ):", "05.04.2025", DATE_PATTERN, "Формат 05.04.2025"),
        ],
    },
    {
        "code": "receipt_money",
        "title": "Расписка о получении денежных средств",
        "template": "receipt_template.jinja",
        "category": "papers",
        "questions": [
            q("receiver_full_name", "ФИО получателя денег полностью:", "Иванов Иван Иванович"),
            q("receiver_passport", "Паспортные данные получателя (0000 000000):", "4500 112244", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("payer_full_name", "ФИО лица, передавшего деньги:", "Петров Пётр Петрович"),
            q("amount_value", "Сумма цифрами (рублей, только цифры и пробелы):", "500 000", AMOUNT_PATTERN, "Пример: 500 000"),
            q("amount_in_words", "Сумма прописью:", "Пятьсот тысяч рублей"),
            q("payment_purpose", "Основание передачи денег (займ, расчёт по договору и т.д.):", "Займ по договору от 15.03.2025"),
            q("return_terms", "Условия и срок возврата (если применимо):", "До 01.10.2025 одним платежом"),
            q(
                "interest_terms",
                "Условия начисления процентов (есть/нет, ставка):",
                "Без процентов",
            ),
            q(
                "late_penalty_terms",
                "Последствия просрочки (неустойка, пени):",
                "Неустойка 0,1% от суммы за каждый день просрочки",
            ),
            q("place_of_issue", "Место составления расписки (город):", "Москва"),
            q("issue_date", "Дата составления расписки (ДД.ММ.ГГГГ):", "15.04.2025", DATE_PATTERN, "Формат 15.04.2025"),
        ],
    },
    {
        "code": "receipt_deposit",
        "title": "Расписка о получении задатка/аванса",
        "template": "receipt_deposit_template.jinja",
        "category": "papers",
        "questions": [
            q("receiver_full_name", "ФИО получателя задатка полностью:", "Сергеев Вадим Николаевич"),
            q("receiver_passport", "Паспортные данные получателя (0000 000000):", "4500 667700", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("amount_value", "Сумма задатка цифрами в рублях:", "150 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("payment_purpose", "Назначение платежа (по какому договору задаток):", "Задаток по договору купли-продажи квартиры"),
            q(
                "deposit_conditions",
                "Условия засчитывания задатка в основную цену или возврата:",
                "Засчитывается в счёт цены договора, при отказе по вине получателя возвращается в двойном размере",
            ),
            q(
                "main_obligation_deadline",
                "Крайний срок заключения основного договора:",
                "До 15.05.2025",
            ),
            q("place_of_issue", "Город составления расписки:", "Самара"),
            q("issue_date", "Дата составления расписки (ДД.ММ.ГГГГ):", "12.04.2025", DATE_PATTERN, "Формат 12.04.2025"),
        ],
    },
    {
        "code": "power_of_attorney",
        "title": "Доверенность",
        "template": "power_of_attorney_template.jinja",
        "category": "papers",
        "questions": [
            q("principal_full_name", "ФИО доверителя полностью:", "Орлова Мария Алексеевна"),
            q("principal_passport", "Паспорт доверителя (0000 000000):", "4500 221144", PASSPORT_PATTERN, "Пример: 4500 221144"),
            q("principal_address", "Адрес регистрации доверителя:", "г. Москва, ул. Южная, д. 3"),
            q("agent_full_name", "ФИО доверенного лица полностью:", "Сафонов Илья Денисович"),
            q("agent_passport", "Паспорт доверенного лица:", "4500 998800", PASSPORT_PATTERN, "Формат 0000 000000"),
            q("authority_scope", "Перечень полномочий, которые нужно предоставить:", "Представлять интересы в Росреестре и подписывать документы"),
            q(
                "authority_limitations",
                "Ограничения и запреты по полномочиям (если есть):",
                "Без права передоверия и заключения сделок отчуждения",
            ),
            q("validity_term", "Срок действия доверенности (укажите дату или период):", "До 31.12.2025"),
            q(
                "revocation_terms",
                "Порядок досрочного отзыва доверенности:",
                "Доверитель вправе отозвать доверенность письменным уведомлением",
            ),
            q("signing_place", "Город подписания доверенности:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "16.04.2025", DATE_PATTERN, "Формат 16.04.2025"),
        ],
    },
    {
        "code": "handover",
        "title": "Акт приёма-передачи имущества",
        "template": "handover_template.jinja",
        "category": "sale",
        "questions": [
            q("party_one", "Наименование или ФИО стороны, передающей имущество:", "ООО «Продавец»"),
            q("party_two", "Наименование или ФИО стороны, принимающей имущество:", "ООО «Покупатель»"),
            q("transfer_basis", "Основание передачи (договор, счёт, заявка):", "Договор поставки №5 от 01.04.2025"),
            q("transfer_subject", "Что передаётся (оборудование, авто, документы и т.п.):", "Оборудование по накладной №12 от 01.04.2025"),
            q("condition_state", "Состояние и комплектация имущества:", "Рабочее состояние, согласно приложенной описи"),
            q("quantity", "Количество или объём (укажите единицы измерения):", "5 комплектов"),
            q(
                "documents_transferred",
                "Перечень передаваемых документов и сопроводительных материалов:",
                "Паспорт изделия, инструкция, гарантийный талон",
            ),
            q(
                "remarks",
                "Замечания и особые отметки при приёмке:",
                "Нареканий нет",
            ),
            q("signing_place", "Город подписания акта:", "Москва"),
            q("signing_date", "Дата подписания акта (ДД.ММ.ГГГГ):", "02.04.2025", DATE_PATTERN, "Формат 02.04.2025"),
        ],
    },
    {
        "code": "refund_agreement",
        "title": "Соглашение о возврате денежных средств",
        "template": "refund_agreement_template.jinja",
        "category": "claims",
        "questions": [
            q("debtor_name", "Кто возвращает деньги (ФИО/компания):", "ООО «Альтаир»"),
            q("creditor_name", "Кому возвращают деньги (ФИО/компания):", "ИП Николаев Н.Н."),
            q("refund_amount", "Сумма возврата в рублях:", "600 000", AMOUNT_PATTERN, "Только цифры и пробелы"),
            q("refund_term", "Срок возврата (конкретная дата):", "До 15.05.2025"),
            q("refund_basis", "Основание возврата (почему возвращают):", "Расторжение договора поставки от 10.03.2025"),
            q(
                "payment_method",
                "Способ возврата и реквизиты:",
                "Безналичный перевод на расчётный счёт №40802810... в Банке Х",
            ),
            q(
                "schedule_details",
                "График выплат, если взносов несколько:",
                "2 равных платежа до 01.05.2025 и 15.05.2025",
            ),
            q(
                "penalty_terms",
                "Неустойка и ответственность за просрочку:",
                "0,1% от суммы задолженности за каждый день",
            ),
            q("signing_place", "Город подписания соглашения:", "Екатеринбург"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "05.04.2025", DATE_PATTERN, "Формат 05.04.2025"),
        ],
    },
    {
        "code": "claim_seller",
        "title": "Претензия продавцу",
        "template": "claim_seller_template.jinja",
        "category": "claims",
        "questions": [
            q("seller_name", "Наименование или ФИО продавца:", "ООО «Маркет»"),
            q("buyer_name", "ФИО заявителя (покупателя):", "Семёнов Антон Григорьевич"),
            q("purchase_subject", "Что было куплено (описание товара, дата покупки):", "Смартфон модель Х, чек №123 от 01.04.2025"),
            q("claim_details", "Опишите выявленный недостаток/нарушение:", "Через 5 дней работы обнаружен существенный дефект дисплея"),
            q("buyer_demand", "Что вы требуете (ремонт, замена, возврат денег):", "Расторгнуть договор и вернуть уплаченную сумму"),
            q("deadline", "Срок исполнения требований (количество дней):", "10 рабочих дней"),
            q("location", "Город составления претензии:", "Москва"),
            q("claim_date", "Дата составления претензии (ДД.ММ.ГГГГ):", "08.04.2025", DATE_PATTERN, "Формат 08.04.2025"),
        ],
    },
    {
        "code": "claim_renter",
        "title": "Претензия арендатору",
        "template": "claim_renter_template.jinja",
        "category": "claims",
        "questions": [
            q("landlord_name", "ФИО/название арендодателя:", "ООО «Дом»"),
            q("tenant_name", "ФИО арендатора:", "Павлов Денис Викторович"),
            q("rental_object", "Адрес арендуемого объекта:", "г. Уфа, ул. Речная, д. 4"),
            q("violation_details", "Опишите нарушение со стороны арендатора:", "Задолженность по аренде более 2 месяцев"),
            q("landlord_demand", "Сформулируйте требования к арендатору:", "Погасить долг и штраф в течение 5 дней"),
            q("deadline", "Срок исполнения требований (например, «5 дней»):", "5 календарных дней"),
            q("location", "Город составления претензии:", "Москва"),
            q("claim_date", "Дата составления претензии (ДД.ММ.ГГГГ):", "06.04.2025", DATE_PATTERN, "Формат 06.04.2025"),
        ],
    },
    {
        "code": "consent_personal",
        "title": "Согласие на обработку персональных данных",
        "template": "consent_personal_template.jinja",
        "category": "papers",
        "questions": [
            q("subject_name", "ФИО субъекта персональных данных:", "Крылова Ольга Дмитриевна"),
            q("passport_details", "Паспортные данные (серия, номер, кем и когда выдан):", "4500 558899, выдан 01.01.2015 ОВД Пресненский"),
            q("address", "Адрес проживания/регистрации:", "г. Москва, ул. Северная, д. 6"),
            q("operator_name", "Наименование оператора, которому даётся согласие:", "ООО «Мой Юрист»"),
            q(
                "data_categories",
                "Перечень персональных данных, которые можно обрабатывать:",
                "ФИО, паспортные данные, адрес, контактный телефон, e-mail",
            ),
            q("processing_purpose", "Цель обработки персональных данных:", "Заключение и исполнение договора аренды"),
            q("validity_term", "Срок действия согласия (например, «5 лет» или конкретная дата):", "5 лет"),
            q(
                "withdrawal_terms",
                "Порядок отзыва согласия и контакт для обращений:",
                "Отзыв возможен по письменному запросу на адрес support@example.com",
            ),
            q("signing_place", "Город подписания согласия:", "Москва"),
            q("signing_date", "Дата подписания (ДД.ММ.ГГГГ):", "09.04.2025", DATE_PATTERN, "Формат 09.04.2025"),
        ],
    },
]


DOCUMENTS = [
    DocumentDefinition(
        code=item["code"],
        title=item["title"],
        template=item["template"],
        category=item["category"],
        questions=item["questions"],
    )
    for item in DOCUMENTS_DATA
]

DOCUMENTS_BY_CODE: Dict[str, DocumentDefinition] = {doc.code: doc for doc in DOCUMENTS}


def get_documents_by_category(category: str) -> List[DocumentDefinition]:
    return [doc for doc in DOCUMENTS if doc.category == category]


def build_categories_keyboard() -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton(text=title, callback_data=f"cat:{slug}")]
        for slug, title in CATEGORY_META.items()
    ]
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def build_documents_keyboard(category: str) -> InlineKeyboardMarkup:
    docs = get_documents_by_category(category)
    buttons = [
        [InlineKeyboardButton(text=doc.title, callback_data=f"doc:{doc.code}")] for doc in docs
    ]
    buttons.append([InlineKeyboardButton(text="◀️ Назад к категориям", callback_data="docs")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def question_controls_keyboard(has_prev: bool) -> InlineKeyboardMarkup:
    rows: List[List[InlineKeyboardButton]] = []
    controls: List[InlineKeyboardButton] = []
    if has_prev:
        controls.append(InlineKeyboardButton(text="⬅️ Назад", callback_data="wizard_back"))
    controls.append(InlineKeyboardButton(text="⛔️ Отмена", callback_data="wizard_cancel"))
    rows.append(controls)
    return InlineKeyboardMarkup(inline_keyboard=rows)


class DocumentForm(StatesGroup):
    choosing_document = State()
    collecting_data = State()
    confirming = State()


def setup_router(settings: Settings, analytics: AnalyticsService, storage: StorageService) -> Router:
    documents_router = Router()
    documents_router.message.middleware(
        DependencyMiddleware(settings=settings, analytics=analytics, storage=storage)
    )
    documents_router.callback_query.middleware(
        DependencyMiddleware(settings=settings, analytics=analytics, storage=storage)
    )
    setup_handlers(documents_router)
    return documents_router


async def show_categories(callback: CallbackQuery) -> None:
    await callback.answer()
    await callback.message.edit_text(
        "Выберите категорию документов ⬇️",
        reply_markup=build_categories_keyboard(),
    )


async def show_category_documents(callback: CallbackQuery) -> None:
    await callback.answer()
    category = callback.data.split(":", maxsplit=1)[1]
    docs = get_documents_by_category(category)
    if not docs:
        await callback.message.answer("Здесь пока пусто, попробуйте другую категорию")
        return
    title = CATEGORY_META.get(category, "Документы")
    await callback.message.edit_text(
        f"{title}\nВыберите нужный шаблон ⬇️",
        reply_markup=build_documents_keyboard(category),
    )


async def start_document(
    callback: CallbackQuery,
    state: FSMContext,
    analytics: AnalyticsService,
    storage: StorageService,
    settings: Settings,
    bot: Bot,
) -> None:
    code = callback.data.split(":", maxsplit=1)[1]
    document = DOCUMENTS_BY_CODE.get(code)
    if not document:
        await callback.answer("Шаблон не найден", show_alert=True)
        return
    user_id = callback.from_user.id
    if not await is_subscribed(bot, user_id):
        await callback.answer()
        await callback.message.answer(
            "Чтобы пользоваться сервисом «Мой Юрист» и создавать документы, нужно подписаться на наш канал. "
            "Это помогает сервису оставаться бесплатным.\n\n"
            "После подписки нажмите «✅ Я подписался».",
            reply_markup=subscription_keyboard(),
        )
        return
    await state.set_state(DocumentForm.collecting_data)
    await state.update_data(document_code=code, answers=[], index=0)
    await callback.answer()
    await callback.message.answer(
        f"📝 Начинаем <b>{document.title}</b>. Отвечайте последовательно — под каждым вопросом есть пример оформления.",
    )
    await ask_next_question(callback.message, state, storage, analytics, settings)
    analytics.log_event("document_selected", callback.from_user.id, {"document": code})


async def ask_next_question(
    message: Message,
    state: FSMContext,
    storage: StorageService,
    analytics: AnalyticsService,
    settings: Settings,
) -> None:
    data = await state.get_data()
    document = DOCUMENTS_BY_CODE[data["document_code"]]
    index = data.get("index", 0)
    total = len(document.questions)
    if index >= total:
        await state.set_state(DocumentForm.confirming)
        await message.answer("✨ Документ готовится...")
        await finalize_document(message, state, storage, analytics, settings)
        return
    question = document.questions[index]
    example_line = f"\n<i>Пример: {question.example}</i>" if question.example else ""
    await message.answer(
        f"<b>Вопрос {index + 1}/{total}</b>\n{question.prompt}{example_line}",
        reply_markup=question_controls_keyboard(index > 0),
    )


async def cancel_creation(message: Message, state: FSMContext) -> None:
    await state.clear()
    await message.answer("🚫 Окей, создание документа остановлено. Возвращайтесь, когда будете готовы! 😊")


async def go_back(
    message: Message,
    state: FSMContext,
    storage: StorageService,
    analytics: AnalyticsService,
    settings: Settings,
) -> None:
    data = await state.get_data()
    index = max(0, data.get("index", 0) - 1)
    await state.update_data(index=index)
    await ask_next_question(message, state, storage, analytics, settings)


async def collect_data(
    message: Message,
    state: FSMContext,
    storage: StorageService,
    analytics: AnalyticsService,
    settings: Settings,
) -> None:
    data = await state.get_data()
    document = DOCUMENTS_BY_CODE[data["document_code"]]
    index = data.get("index", 0)
    question = document.questions[index]
    user_answer = message.text.strip()
    if question.uppercase:
        user_answer = user_answer.upper()
    if question.pattern and not re.fullmatch(question.pattern, user_answer):
        hint = question.error_hint or "Используйте формат из примера."
        await message.answer(f"⚠️ Некорректный формат ответа. {hint}")
        return
    answers: List[str] = data.get("answers", [])
    answers.append(user_answer)
    await state.update_data(answers=answers, index=index + 1)
    await ask_next_question(message, state, storage, analytics, settings)


async def finalize_document(
    message: Message,
    state: FSMContext,
    storage: StorageService,
    analytics: AnalyticsService,
    settings: Settings,
) -> None:
    user_id = message.from_user.id
    if not await can_create_document(user_id, limit=settings.monthly_document_limit):
        await message.answer(
            f"Вы уже создали {settings.monthly_document_limit} документов в этом месяце. Лимит обновится в следующем месяце."
        )
        await state.clear()
        return
    data = await state.get_data()
    document = DOCUMENTS_BY_CODE[data["document_code"]]
    answers: List[str] = data.get("answers", [])
    context = {question.key: answer for question, answer in zip(document.questions, answers)}
    context["document_title"] = document.title
    template_loader = TemplateLoader(TEMPLATES_DIR)
    pdf_builder = PdfBuilder(template_loader)
    pdf_file = pdf_builder.build(document.template, context)
    pdf_bytes = pdf_file.getvalue()
    pdf_file.close()

    storage.register_generation(message.from_user.id, document.title)
    await register_document_usage(user_id)
    storage.remember_last_document(
        message.from_user.id,
        GeneratedDocument(
            code=document.code,
            title=document.title,
            template_name=document.template,
            context=dict(context),
        ),
    )
    analytics.log_event("document_generated", message.from_user.id, {"document": document.title})

    document_file = BufferedInputFile(pdf_bytes, filename=f"{document.code}.pdf")
    await message.answer_document(document_file, caption=f"Готово! <b>{document.title}</b> сформирован ✅")
    await message.answer(
        "Хотите продолжить?",
        reply_markup=InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="🔁 К категориям", callback_data="docs")],
                [InlineKeyboardButton(text="💬 Оставить отзыв", callback_data="feedback_start")],
                [InlineKeyboardButton(text="📄 DOCX-файл", callback_data="docx_download")],
                [InlineKeyboardButton(text="🚀 Про-режим в разработке", callback_data="upgrade")],
            ]
        ),
    )
    await state.clear()


async def send_docx(callback: CallbackQuery, storage: StorageService) -> None:
    await callback.answer()
    last_document = storage.get_last_document(callback.from_user.id)
    if not last_document:
        await callback.message.answer(
            "Чтобы получить DOCX, сначала сформируйте документ."
        )
        return

    template_loader = TemplateLoader(TEMPLATES_DIR)
    docx_builder = DocxBuilder(template_loader)
    docx_file = docx_builder.build(last_document.template_name, last_document.context)
    docx_bytes = docx_file.getvalue()
    docx_file.close()

    await callback.message.answer_document(
        BufferedInputFile(docx_bytes, filename=f"{last_document.code}.docx"),
        caption=f"DOCX-версия: {last_document.title}",
    )


async def upgrade_placeholder(callback: CallbackQuery) -> None:
    await callback.answer("Pro-возможности в работе. Следите за обновлениями!", show_alert=True)


async def show_docs(callback: CallbackQuery) -> None:
    await show_categories(callback)


async def check_subscription_handler(callback: CallbackQuery, bot: Bot) -> None:
    user_id = callback.from_user.id
    if await is_subscribed(bot, user_id):
        await callback.answer("Подписка подтверждена!", show_alert=False)
        await callback.message.answer(
            "✅ Подписка подтверждена! Теперь вы можете создавать документы.\n\nВыберите категорию:",
            reply_markup=build_categories_keyboard(),
        )
    else:
        await callback.answer(
            "Подписка пока не найдена. Убедитесь, что подписались на канал и попробуйте ещё раз.",
            show_alert=True,
        )


async def wizard_back(
    callback: CallbackQuery,
    state: FSMContext,
    storage: StorageService,
    analytics: AnalyticsService,
    settings: Settings,
) -> None:
    await callback.answer()
    await go_back(callback.message, state, storage, analytics, settings)


async def wizard_cancel(callback: CallbackQuery, state: FSMContext) -> None:
    await callback.answer()
    await cancel_creation(callback.message, state)
    await callback.message.answer(
        "Вы вернулись в главное меню. Выберите категорию документов:",
        reply_markup=build_categories_keyboard(),
    )


def setup_handlers(router: Router) -> None:
    router.callback_query.register(show_docs, F.data == "docs")
    router.callback_query.register(show_category_documents, F.data.startswith("cat:"))
    router.callback_query.register(start_document, F.data.startswith("doc:"))
    router.callback_query.register(send_docx, F.data == "docx_download")
    router.callback_query.register(upgrade_placeholder, F.data == "upgrade")
    router.callback_query.register(check_subscription_handler, F.data == "check_subscription")
    router.callback_query.register(wizard_back, F.data == "wizard_back")
    router.callback_query.register(wizard_cancel, F.data == "wizard_cancel")
    router.message.register(cancel_creation, Command("cancel"))
    router.message.register(go_back, Command("back"))
    router.message.register(collect_data, DocumentForm.collecting_data)
